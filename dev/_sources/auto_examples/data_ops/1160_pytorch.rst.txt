
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/data_ops/1160_pytorch.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_data_ops_1160_pytorch.py>`
        to download the full example code or to run this example in your browser via JupyterLite or Binder.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_data_ops_1160_pytorch.py:


Using PyTorch (via skorch) in DataOps
======================================

This example shows how to wrap a PyTorch model with skorch and plug it into a
skrub DataOps plan.

.. note::
    This example requires the optional dependencies ``torch`` and ``skorch``.

The main goal here is to show the *integration pattern*:

- **PyTorch** defines the model (an ``nn.Module``)
- **skorch** wraps it as a scikit-learn compatible estimator
- **skrub DataOps** builds a plan and can tune skorch (and therefore PyTorch)
  hyperparameters using the skrub choices.

.. GENERATED FROM PYTHON SOURCE LINES 20-27

Loading the data
=================

We use scikit-learn's digits dataset because it is small and ships with
scikit-learn. Each sample is an 8x8 grayscale image of a
handwritten digit, encoded as 64 pixel intensity values and displays a
number from 0 to 9.

.. GENERATED FROM PYTHON SOURCE LINES 27-34

.. code-block:: Python

    from sklearn.datasets import load_digits

    digits = load_digits()
    X, y = digits.data, digits.target
    print(f"Dataset shape: {X.shape}")
    print(f"Number of classes: {len(set(y))}")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Dataset shape: (1797, 64)
    Number of classes: 10




.. GENERATED FROM PYTHON SOURCE LINES 35-39

Start of the DataOps plan
==========================

We start the DataOps plan by creating the skrub variables X and y.

.. GENERATED FROM PYTHON SOURCE LINES 39-44

.. code-block:: Python

    import skrub

    X = skrub.X(X)
    y = skrub.y(y)








.. GENERATED FROM PYTHON SOURCE LINES 45-65

Data preprocessing
==================

We start by normalizing the pixel values to [0, 1] by first
computing the global max value and then dividing the pixel values
by this max value. Importantly, we freeze the max value (scaling factor)
after fitting so that the same rescaling is applied later when we use our
dataop for prediction on new (test) data.

A convolutional network expects images with shape (N, C, H, W) where:

- N: number of samples
- C: number of color channels (1 for grayscale)
- H, W: image height and width

So we reshape the images to (N, 1, 8, 8) for the CNN. The -1 means the first
dimension (N) is inferred automatically from the array size.

The advantage of using DataOps is that the preprocessing steps are tracked
in the plan and will be automatically applied during prediction.

.. GENERATED FROM PYTHON SOURCE LINES 65-72

.. code-block:: Python


    max_value = X.max().skb.freeze_after_fit()
    X_scaled = X / max_value
    X_reshaped = X_scaled.reshape(-1, 1, 8, 8).astype("float32")
    X_reshaped.skb.draw_graph()







.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
     "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
    <!-- Generated by graphviz version 14.1.2 (20260126.1125)
     -->
    <!-- Title: G Pages: 1 -->
    <svg width="180pt" height="351pt"
     viewBox="0.00 0.00 180.00 351.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 346.62)">

    <polygon fill="white" stroke="none" points="-4,4 -4,-346.62 176.03,-346.62 176.03,4 -4,4"/>
    <!-- node_0 -->
    <g id="node_0" class="node">

    <g id="a_node_0"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 41, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;X = skrub.X(X)">
    <polygon fill="#c6d5f0" stroke="black" points="136.9,-338.62 66.25,-338.62 66.25,-312.85 136.9,-312.85 136.9,-338.62"/>
    <polygon fill="none" stroke="black" points="140.9,-342.62 62.25,-342.62 62.25,-308.85 140.9,-308.85 140.9,-342.62"/>
    <text xml:space="preserve" text-anchor="middle" x="101.58" y="-321.46" font-family="sans-serif" font-size="12.00">X: Var &#39;X&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_1 -->
    <g id="node_1" class="node">

    <g id="a_node_1"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 66, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;max_value = X.max().skb.freeze_after_fit()">
    <polygon fill="none" stroke="black" points="117.15,-272.85 0,-272.85 0,-247.08 117.15,-247.08 117.15,-272.85"/>
    <text xml:space="preserve" text-anchor="middle" x="58.58" y="-255.69" font-family="sans-serif" font-size="12.00">CallMethod &#39;max&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_0&#45;&gt;node_1 -->
    <g id="edge6" class="edge">

    <path fill="none" stroke="black" d="M90.72,-308.64C85.36,-300.69 78.81,-290.98 73.03,-282.4"/>
    <polygon fill="black" stroke="black" points="76.05,-280.61 67.55,-274.28 70.24,-284.53 76.05,-280.61"/>
    </g>
    <!-- node_3 -->
    <g id="node_3" class="node">

    <g id="a_node_3"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 67, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;X_scaled = X / max_value">
    <polygon fill="none" stroke="black" points="152.53,-149.31 52.62,-149.31 52.62,-123.54 152.53,-123.54 152.53,-149.31"/>
    <text xml:space="preserve" text-anchor="middle" x="102.58" y="-132.15" font-family="sans-serif" font-size="12.00">BinOp: truediv</text>
    </a>
    </g>
    </g>
    <!-- node_0&#45;&gt;node_3 -->
    <g id="edge3" class="edge">

    <path fill="none" stroke="black" d="M111.68,-308.61C117.28,-298.7 123.68,-285.52 126.58,-272.85 130.78,-254.44 124.1,-196.12 121.58,-185.31 119.61,-176.88 116.41,-167.99 113.2,-160.18"/>
    <polygon fill="black" stroke="black" points="116.44,-158.85 109.23,-151.09 110.03,-161.65 116.44,-158.85"/>
    </g>
    <!-- node_2 -->
    <g id="node_2" class="node">

    <g id="a_node_2"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 66, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;max_value = X.max().skb.freeze_after_fit()">
    <polygon fill="none" stroke="black" points="112.28,-211.08 16.88,-211.08 16.88,-185.31 112.28,-185.31 112.28,-211.08"/>
    <text xml:space="preserve" text-anchor="middle" x="64.58" y="-193.92" font-family="sans-serif" font-size="12.00">FreezeAfterFit</text>
    </a>
    </g>
    </g>
    <!-- node_1&#45;&gt;node_2 -->
    <g id="edge5" class="edge">

    <path fill="none" stroke="black" d="M59.82,-246.58C60.5,-239.77 61.37,-231.08 62.18,-223.01"/>
    <polygon fill="black" stroke="black" points="65.67,-223.37 63.18,-213.07 58.7,-222.67 65.67,-223.37"/>
    </g>
    <!-- node_2&#45;&gt;node_3 -->
    <g id="edge4" class="edge">

    <path fill="none" stroke="black" d="M72.45,-184.81C77.14,-177.44 83.22,-167.87 88.69,-159.26"/>
    <polygon fill="black" stroke="black" points="91.49,-161.39 93.9,-151.07 85.58,-157.63 91.49,-161.39"/>
    </g>
    <!-- node_4 -->
    <g id="node_4" class="node">

    <g id="a_node_4"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 68, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;X_reshaped = X_scaled.reshape(&#45;1, 1, 8, 8).astype(&quot;float32&quot;)">
    <polygon fill="none" stroke="black" points="172.03,-87.54 33.12,-87.54 33.12,-61.77 172.03,-61.77 172.03,-87.54"/>
    <text xml:space="preserve" text-anchor="middle" x="102.58" y="-70.38" font-family="sans-serif" font-size="12.00">CallMethod &#39;reshape&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_3&#45;&gt;node_4 -->
    <g id="edge2" class="edge">

    <path fill="none" stroke="black" d="M102.58,-123.04C102.58,-116.23 102.58,-107.54 102.58,-99.47"/>
    <polygon fill="black" stroke="black" points="106.08,-99.54 102.58,-89.54 99.08,-99.54 106.08,-99.54"/>
    </g>
    <!-- node_5 -->
    <g id="node_5" class="node">

    <g id="a_node_5"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 68, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;X_reshaped = X_scaled.reshape(&#45;1, 1, 8, 8).astype(&quot;float32&quot;)">
    <polygon fill="none" stroke="black" points="167.9,-25.77 37.25,-25.77 37.25,0 167.9,0 167.9,-25.77"/>
    <text xml:space="preserve" text-anchor="middle" x="102.58" y="-8.61" font-family="sans-serif" font-size="12.00">CallMethod &#39;astype&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_4&#45;&gt;node_5 -->
    <g id="edge1" class="edge">

    <path fill="none" stroke="black" d="M102.58,-61.27C102.58,-54.46 102.58,-45.77 102.58,-37.7"/>
    <polygon fill="black" stroke="black" points="106.08,-37.77 102.58,-27.77 99.08,-37.77 106.08,-37.77"/>
    </g>
    </g>
    </svg>

    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 73-86

Building a NN Classifier
=========================

We'll build a tiny CNN using PyTorch and wrap it with skorch to make it
scikit-learn compatible. The architecture uses a single convolution + pooling
stage and a small MLP head. The architectural choices below are meant to be:

- **standard**: 3x3 convolutions and 2x2 max-pooling are very common
- **small**: the dataset and images are tiny, so we keep the model tiny too

If you want more background on CNN building blocks and how convolution/pooling
changes tensor shapes, see the CS231n notes:
https://cs231n.github.io/convolutional-networks/

.. GENERATED FROM PYTHON SOURCE LINES 86-120

.. code-block:: Python

    import torch.nn as nn
    import torch.nn.functional as F
    import torch.optim as optim


    class TinyCNN(nn.Module):
        def __init__(self, conv_channels: int = 8, hidden_units: int = 32):
            super().__init__()
            self.conv_channels = conv_channels
            self.hidden_units = hidden_units

            # 2-level CNN with 2x2 max-pooling
            self.conv1 = nn.Conv2d(
                in_channels=1, out_channels=conv_channels, kernel_size=3, padding=1
            )
            self.conv2 = nn.Conv2d(conv_channels, conv_channels, kernel_size=3, padding=1)
            self.pool = nn.MaxPool2d(kernel_size=2)

            # input shape = (8,8) -> conv1: (8,8) -> conv2: (8,8) -> pool: (4,4)
            image_shape_after_conv = 4 * 4

            # MLP head
            self.fc1 = nn.Linear(conv_channels * image_shape_after_conv, hidden_units)
            self.dropout = nn.Dropout(p=0.25)  # Regularization to avoid overfitting
            self.fc2 = nn.Linear(hidden_units, 10)  # 10 digit classes (0..9)

        def forward(self, x):
            x = F.relu(self.conv1(x))
            x = self.pool(F.relu(self.conv2(x)))
            x = x.flatten(start_dim=1)
            x = self.dropout(F.relu(self.fc1(x)))
            return self.fc2(x)









.. GENERATED FROM PYTHON SOURCE LINES 121-128

Skorch provides scikit-learn compatible wrappers around torch training loops.
That makes the torch model usable by skrub DataOps (and scikit-learn tools in
general).

We use :func:`skrub.choose_from()` to define hyperparameters that the DataOps
grid search will tune: conv_channels, hidden_units, and max_epochs.
The other parameters are set to common choices for this task and training data size.

.. GENERATED FROM PYTHON SOURCE LINES 128-148

.. code-block:: Python


    from skorch import NeuralNetClassifier

    device = "cpu"  # use "cuda" or "mps" if available

    net = NeuralNetClassifier(
        module=TinyCNN,
        # These choices are intentionally small so the example runs quickly.
        module__conv_channels=skrub.choose_from([8, 16], name="conv_channels"),
        module__hidden_units=skrub.choose_from([8, 16, 32], name="hidden_units"),
        max_epochs=skrub.choose_from([10, 15], name="max_epochs"),
        optimizer__lr=0.01,
        optimizer=optim.Adam,
        criterion=nn.CrossEntropyLoss,
        device=device,
        train_split=None,  # We'll use skrub's grid search for validation
        verbose=0,
    )









.. GENERATED FROM PYTHON SOURCE LINES 149-155

Tuning the model's hyperparameters with DataOps
===============================================

We integrate the model into the DataOps plan. First, we
convert the target labels to integers for the loss computation
and apply the model to the preprocessed X and y.

.. GENERATED FROM PYTHON SOURCE LINES 155-160

.. code-block:: Python


    y_int = y.astype("int64")
    predictor = X_reshaped.skb.apply(net, y=y_int)
    predictor.skb.draw_graph()






.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
     "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
    <!-- Generated by graphviz version 14.1.2 (20260126.1125)
     -->
    <!-- Title: G Pages: 1 -->
    <svg width="325pt" height="420pt"
     viewBox="0.00 0.00 325.00 420.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 416.39)">

    <polygon fill="white" stroke="none" points="-4,4 -4,-416.39 320.9,-416.39 320.9,4 -4,4"/>
    <!-- node_0 -->
    <g id="node_0" class="node">

    <g id="a_node_0"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 41, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;X = skrub.X(X)">
    <polygon fill="#c6d5f0" stroke="black" points="136.9,-408.39 66.25,-408.39 66.25,-382.62 136.9,-382.62 136.9,-408.39"/>
    <polygon fill="none" stroke="black" points="140.9,-412.39 62.25,-412.39 62.25,-378.62 140.9,-378.62 140.9,-412.39"/>
    <text xml:space="preserve" text-anchor="middle" x="101.58" y="-391.23" font-family="sans-serif" font-size="12.00">X: Var &#39;X&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_1 -->
    <g id="node_1" class="node">

    <g id="a_node_1"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 66, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;max_value = X.max().skb.freeze_after_fit()">
    <polygon fill="none" stroke="black" points="117.15,-342.62 0,-342.62 0,-316.85 117.15,-316.85 117.15,-342.62"/>
    <text xml:space="preserve" text-anchor="middle" x="58.58" y="-325.46" font-family="sans-serif" font-size="12.00">CallMethod &#39;max&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_0&#45;&gt;node_1 -->
    <g id="edge8" class="edge">

    <path fill="none" stroke="black" d="M90.72,-378.41C85.36,-370.46 78.81,-360.75 73.03,-352.17"/>
    <polygon fill="black" stroke="black" points="76.05,-350.38 67.55,-344.05 70.24,-354.3 76.05,-350.38"/>
    </g>
    <!-- node_3 -->
    <g id="node_3" class="node">

    <g id="a_node_3"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 67, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;X_scaled = X / max_value">
    <polygon fill="none" stroke="black" points="152.53,-219.08 52.62,-219.08 52.62,-193.31 152.53,-193.31 152.53,-219.08"/>
    <text xml:space="preserve" text-anchor="middle" x="102.58" y="-201.92" font-family="sans-serif" font-size="12.00">BinOp: truediv</text>
    </a>
    </g>
    </g>
    <!-- node_0&#45;&gt;node_3 -->
    <g id="edge5" class="edge">

    <path fill="none" stroke="black" d="M111.68,-378.38C117.28,-368.47 123.68,-355.29 126.58,-342.62 130.78,-324.21 124.1,-265.89 121.58,-255.08 119.61,-246.65 116.41,-237.76 113.2,-229.95"/>
    <polygon fill="black" stroke="black" points="116.44,-228.62 109.23,-220.86 110.03,-231.42 116.44,-228.62"/>
    </g>
    <!-- node_2 -->
    <g id="node_2" class="node">

    <g id="a_node_2"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 66, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;max_value = X.max().skb.freeze_after_fit()">
    <polygon fill="none" stroke="black" points="112.28,-280.85 16.88,-280.85 16.88,-255.08 112.28,-255.08 112.28,-280.85"/>
    <text xml:space="preserve" text-anchor="middle" x="64.58" y="-263.69" font-family="sans-serif" font-size="12.00">FreezeAfterFit</text>
    </a>
    </g>
    </g>
    <!-- node_1&#45;&gt;node_2 -->
    <g id="edge7" class="edge">

    <path fill="none" stroke="black" d="M59.82,-316.35C60.5,-309.54 61.37,-300.85 62.18,-292.78"/>
    <polygon fill="black" stroke="black" points="65.67,-293.14 63.18,-282.84 58.7,-292.44 65.67,-293.14"/>
    </g>
    <!-- node_2&#45;&gt;node_3 -->
    <g id="edge6" class="edge">

    <path fill="none" stroke="black" d="M72.45,-254.58C77.14,-247.21 83.22,-237.64 88.69,-229.03"/>
    <polygon fill="black" stroke="black" points="91.49,-231.16 93.9,-220.84 85.58,-227.4 91.49,-231.16"/>
    </g>
    <!-- node_4 -->
    <g id="node_4" class="node">

    <g id="a_node_4"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 68, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;X_reshaped = X_scaled.reshape(&#45;1, 1, 8, 8).astype(&quot;float32&quot;)">
    <polygon fill="none" stroke="black" points="172.03,-153.31 33.12,-153.31 33.12,-127.54 172.03,-127.54 172.03,-153.31"/>
    <text xml:space="preserve" text-anchor="middle" x="102.58" y="-136.15" font-family="sans-serif" font-size="12.00">CallMethod &#39;reshape&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_3&#45;&gt;node_4 -->
    <g id="edge4" class="edge">

    <path fill="none" stroke="black" d="M102.58,-192.9C102.58,-185.05 102.58,-174.61 102.58,-165.18"/>
    <polygon fill="black" stroke="black" points="106.08,-165.2 102.58,-155.2 99.08,-165.2 106.08,-165.2"/>
    </g>
    <!-- node_5 -->
    <g id="node_5" class="node">

    <g id="a_node_5"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 68, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;X_reshaped = X_scaled.reshape(&#45;1, 1, 8, 8).astype(&quot;float32&quot;)">
    <polygon fill="none" stroke="black" points="167.9,-87.54 37.25,-87.54 37.25,-61.77 167.9,-61.77 167.9,-87.54"/>
    <text xml:space="preserve" text-anchor="middle" x="102.58" y="-70.38" font-family="sans-serif" font-size="12.00">CallMethod &#39;astype&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_4&#45;&gt;node_5 -->
    <g id="edge3" class="edge">

    <path fill="none" stroke="black" d="M102.58,-127.13C102.58,-119.28 102.58,-108.84 102.58,-99.41"/>
    <polygon fill="black" stroke="black" points="106.08,-99.43 102.58,-89.43 99.08,-99.43 106.08,-99.43"/>
    </g>
    <!-- node_8 -->
    <g id="node_8" class="node">

    <g id="a_node_8"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 157, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;predictor = X_reshaped.skb.apply(net, y=y_int)">
    <polygon fill="none" stroke="black" points="259.52,-25.77 93.62,-25.77 93.62,0 259.52,0 259.52,-25.77"/>
    <text xml:space="preserve" text-anchor="middle" x="176.57" y="-8.61" font-family="sans-serif" font-size="12.00">Apply NeuralNetClassifier</text>
    </a>
    </g>
    </g>
    <!-- node_5&#45;&gt;node_8 -->
    <g id="edge1" class="edge">

    <path fill="none" stroke="black" d="M117.91,-61.27C127.93,-53.18 141.22,-42.44 152.62,-33.23"/>
    <polygon fill="black" stroke="black" points="154.5,-36.21 160.08,-27.2 150.11,-30.77 154.5,-36.21"/>
    </g>
    <!-- node_6 -->
    <g id="node_6" class="node">

    <g id="a_node_6"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 42, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;y = skrub.y(y)">
    <polygon fill="#fad9c6" stroke="black" points="285.02,-153.31 218.12,-153.31 218.12,-127.54 285.02,-127.54 285.02,-153.31"/>
    <polygon fill="none" stroke="black" points="289.02,-157.31 214.12,-157.31 214.12,-123.54 289.02,-123.54 289.02,-157.31"/>
    <text xml:space="preserve" text-anchor="middle" x="251.57" y="-136.15" font-family="sans-serif" font-size="12.00">y: Var &#39;y&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_7 -->
    <g id="node_7" class="node">

    <g id="a_node_7"><a xlink:title=" &#160;&#160;&#160;&#160;&#160;File &quot;/home/circleci/project/examples/data_ops/1160_pytorch.py&quot;, line 156, in &lt;module&gt;&#10; &#160;&#160;&#160;&#160;&#160;&#160;&#160;y_int = y.astype(&quot;int64&quot;)">
    <polygon fill="none" stroke="black" points="316.9,-87.54 186.25,-87.54 186.25,-61.77 316.9,-61.77 316.9,-87.54"/>
    <text xml:space="preserve" text-anchor="middle" x="251.57" y="-70.38" font-family="sans-serif" font-size="12.00">CallMethod &#39;astype&#39;</text>
    </a>
    </g>
    </g>
    <!-- node_6&#45;&gt;node_7 -->
    <g id="edge9" class="edge">

    <path fill="none" stroke="black" d="M251.57,-123.33C251.57,-115.98 251.57,-107.13 251.57,-99.07"/>
    <polygon fill="black" stroke="black" points="255.08,-99.23 251.58,-89.23 248.08,-99.23 255.08,-99.23"/>
    </g>
    <!-- node_7&#45;&gt;node_8 -->
    <g id="edge2" class="edge">

    <path fill="none" stroke="black" d="M236.03,-61.27C225.88,-53.18 212.4,-42.44 200.85,-33.23"/>
    <polygon fill="black" stroke="black" points="203.28,-30.69 193.28,-27.2 198.92,-36.17 203.28,-30.69"/>
    </g>
    </g>
    </svg>

    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 161-163

Finally, we use 4-fold cross-validation for the hyperparameter
tuning on our DataOps plan.

.. GENERATED FROM PYTHON SOURCE LINES 163-175

.. code-block:: Python


    from sklearn.model_selection import KFold

    cv = KFold(n_splits=4, shuffle=True, random_state=42)
    search = predictor.skb.make_grid_search(
        cv=cv,
        fitted=True,
        n_jobs=-1,
    )
    print("\nSearch results:")
    print(search.results_.to_string(index=False))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    Search results:
     max_epochs  conv_channels  hidden_units  mean_test_score
             15             16            32         0.974396
             10             16            32         0.972169
             15              8            32         0.966601
             15             16            16         0.963813
             10              8            32         0.950462
             15              8            16         0.948796
             10             16            16         0.947681
             10              8            16         0.924310
             15              8             8         0.907618
             10             16             8         0.861941
             15             16             8         0.855271
             10              8             8         0.708310




.. GENERATED FROM PYTHON SOURCE LINES 176-179

Let's take a better look at the well-performing models by looking
at the parallel coordinates plot. We filter to models with
score >= 0.94 to focus on the top-performing configurations.

.. GENERATED FROM PYTHON SOURCE LINES 179-183

.. code-block:: Python


    fig = search.plot_results(min_score=0.94)
    fig






.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <div>                        <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
            <script charset="utf-8" src="https://cdn.plot.ly/plotly-3.3.1.min.js" integrity="sha256-4rD3fugVb/nVJYUv5Ky3v+fYXoouHaBSP20WIJuEiWg=" crossorigin="anonymous"></script>                <div id="141b2cda-fe6f-4e12-8326-cdbe2d633e0a" class="plotly-graph-div" style="height:100%; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("141b2cda-fe6f-4e12-8326-cdbe2d633e0a")) {                    Plotly.newPlot(                        "141b2cda-fe6f-4e12-8326-cdbe2d633e0a",                        [{"dimensions":[{"label":"max_epochs","ticktext":["10","11","12","13","14","15"],"tickvals":[10,11,12,13,14,15],"values":{"dtype":"f8","bdata":"AAAAAAAALkAAAAAAAAAkQAAAAAAAAC5AAAAAAAAALkAAAAAAAAAkQGhBBKpD\u002fS1AAAAAAAAAJEA="}},{"label":"conv_channels","ticktext":["8","9","10","11","12","13","14","15","16"],"tickvals":[8,9,10,11,12,13,14,15,16],"values":{"dtype":"f8","bdata":"AAAAAAAAMEBwR6xDdf4vQAAAAAAAACBAAAAAAAAAMEAAAAAAAAAgQKFFjCHUBCBAAAAAAAAAMEA="}},{"label":"hidden_units","ticktext":["16","18","20","21","23","25","27","28","30","32"],"tickvals":[16,18,20,21,23,25,27,28,30,32],"values":{"dtype":"f8","bdata":"AAAAAAAAQEBAGmNgRPQ\u002fQAAAAAAAAEBAAAAAAAAAMEAAAAAAAABAQAAAAAAAADBAAAAAAAAAMEA="}},{"label":"score time","ticktext":["0.0155","0.0165","0.0176","0.0186","0.0197","0.0208","0.0218","0.0229","0.0239","0.0250"],"tickvals":[0.015489399433135986,0.016542043950822618,0.01759468846850925,0.01864733298619588,0.019699977503882513,0.020752622021569148,0.02180526653925578,0.02285791105694241,0.023910555574629042,0.024963200092315674],"values":{"dtype":"f8","bdata":"qMX+I98JmT8AAAAA9I+ZP8EVPa0cJpI\u002fnOJskI1plT99YYHXRo+RPwAAAADouI8\u002fJcQjFgt5kz8="}},{"label":"fit time","ticktext":["0.62","0.68","0.74","0.81","0.87","0.93","0.99","1.06","1.12","1.18"],"tickvals":[0.6166662573814392,0.6795961062113444,0.7425259550412496,0.8054558038711548,0.86838565270106,0.9313155015309652,0.9942453503608704,1.0571751991907756,1.120105048020681,1.183034896850586],"values":{"dtype":"f8","bdata":"AAAAALbt8j8aHf0hjIrnP1VUCeyEOO8\u002fskzoWlHL8j8AAADgurvjP6M6SgF8wu4\u002fEm+A7Db75j8="}},{"label":"score","ticktext":["0.948","0.951","0.954","0.957","0.960","0.963","0.965","0.968","0.971","0.974"],"tickvals":[0.9476812670131155,0.9506495916852263,0.9536179163573372,0.9565862410294481,0.959554565701559,0.9625228903736698,0.9654912150457806,0.9684595397178916,0.9714278643900024,0.9743961890621132],"values":{"dtype":"f8","bdata":"Sc2r6kAu7z\u002fqtRQzAhzvP3n7Gmhl7u4\u002fxkDHOY\u002fX7j\u002f0TMFGLmruPw94Lp6JXO4\u002fNU0bqmdT7j8="}}],"labelangle":15,"labelside":"top","line":{"color":{"dtype":"f8","bdata":"Sc2r6kAu7z\u002fqtRQzAhzvP3n7Gmhl7u4\u002fxkDHOY\u002fX7j\u002f0TMFGLmruPw94Lp6JXO4\u002fNU0bqmdT7j8="},"colorbar":{"title":{"text":"score"}},"colorscale":[[0.0,"rgb(0,0,255)"],[1.0,"rgb(255,0,0)"]],"showscale":true},"type":"parcoords"}],                        {"font":{"size":18},"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}}},                        {"responsive": true}                    )                };            </script>        </div>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 184-196

Interpreting the results
========================

Looking at the search results, we can observe several patterns:

- **Model capacity matters**: Larger configurations with ``conv_channels=16``
  and ``hidden_units=32`` tend to perform best. Smaller models with
  ``conv_channels=8`` and/or ``hidden_units=8`` perform significantly worse,
  indicating that the task benefits from increased model capacity.
- **More epochs generally help**: Configurations with ``max_epochs=15`` tend to
  perform slightly better than those with ``max_epochs=10``, though the gains
  are modest compared to architectural changes.

.. GENERATED FROM PYTHON SOURCE LINES 198-219

Conclusion
==========

In this example, we've shown how to use **PyTorch** and **skorch** within
skrub DataOps. The key steps were:

1. Define a PyTorch ``nn.Module`` (our ``TinyCNN``)
2. Wrap it with skorch's ``NeuralNetClassifier`` to make it scikit-learn compatible
3. Use :func:`skrub.choose_from()` to specify hyperparameters for tuning
4. Integrate it into a DataOps plan and use grid search to find the best configuration

This pattern lets you leverage PyTorch's flexibility for model definition while
benefiting from skrub's hyperparameter tuning and data preprocessing capabilities.

.. seealso::

   * :ref:`example_tuning_pipelines`: Learn more about using
     ``skrub.choose_from()`` and other choice objects to tune hyperparameters
     in DataOps plans.
   * :ref:`example_optuna_choices`: Discover how to use Optuna as a backend
     for more sophisticated hyperparameter search strategies with skrub DataOps.


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 24.676 seconds)

**Estimated memory usage:**  525 MB


.. _sphx_glr_download_auto_examples_data_ops_1160_pytorch.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: binder-badge

      .. image:: images/binder_badge_logo.svg
        :target: https://mybinder.org/v2/gh/skrub-data/skrub/main?urlpath=lab/tree/notebooks/auto_examples/data_ops/1160_pytorch.ipynb
        :alt: Launch binder
        :width: 150 px

    .. container:: lite-badge

      .. image:: images/jupyterlite_badge_logo.svg
        :target: ../../lite/lab/index.html?path=auto_examples/data_ops/1160_pytorch.ipynb
        :alt: Launch JupyterLite
        :width: 150 px

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: 1160_pytorch.ipynb <1160_pytorch.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: 1160_pytorch.py <1160_pytorch.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: 1160_pytorch.zip <1160_pytorch.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
